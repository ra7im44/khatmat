<div class="quran-page min-h-screen pb-24 relative" [class.dark]="isDarkMode()" [class.focus-active]="focusMode()"
  dir="rtl">
  <div class="fixed top-0 left-0 right-0 h-1.5 z-50 bg-surface-el/70">
    <div class="h-full quran-progress transition-all duration-300" [style.width.%]="scrollProgress()"></div>
  </div>

  <!-- â•â•â• CONTINUE READING BANNER â•â•â• -->
  <div class="continue-banner" *ngIf="showContinueReading() && !loading()">
    <span>ğŸ“– Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ù† Ø¢Ø®Ø± Ù…ÙˆØ¶Ø¹ Ù‚Ø±Ø§Ø¡Ø©</span>
    <button (click)="continueReading()" class="continue-btn">Ù…ØªØ§Ø¨Ø¹Ø©</button>
    <button (click)="showContinueReading.set(false)" class="continue-dismiss">âœ•</button>
  </div>

  <!-- â•â•â• HEADER (hideable in focus) â•â•â• -->
  <header class="relative z-30 px-3 md:px-6 py-2 md:py-4 quran-header chrome-el">
    <div
      class="max-w-5xl mx-auto quran-header-inner rounded-2xl md:rounded-3xl border border-brd/60 px-3 md:px-6 py-2.5 md:py-4">
      <div class="flex items-center justify-between gap-2 md:gap-6">
        <!-- Right side: Back + Title -->
        <div class="flex items-center gap-2 md:gap-4 min-w-0">
          <a [routerLink]="khatmaId() ? ['/khatmat', khatmaId()] : ['/khatmat']"
            class="w-9 h-9 md:w-11 md:h-11 shrink-0 rounded-xl md:rounded-2xl border border-brd/60 bg-surface-el/60 inline-flex items-center justify-center text-txt-muted hover:text-primary hover:border-primary/40 transition-colors">
            <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
            </svg>
          </a>
          <div class="min-w-0">
            <h1 class="text-sm md:text-2xl font-black text-txt leading-tight">Ø§Ù„Ø¬Ø²Ø¡ {{juzNumber()}}</h1>
            @if (khatmaId(); as id) {
            <p class="text-[10px] text-txt-muted">Ø§Ù„Ø®ØªÙ…Ø© #{{id}}</p>
            }
          </div>
        </div>

        <!-- Center: Reading Mode Switcher (always visible) -->
        <div class="mode-switcher">
          <button (click)="setReadingMode('continuous')" [class.active]="readingMode() === 'continuous'"
            title="ØªÙ…Ø±ÙŠØ± Ù…Ø³ØªÙ…Ø±">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
            </svg>
          </button>
          <button (click)="setReadingMode('verse')" [class.active]="readingMode() === 'verse'" title="Ø¢ÙŠØ© Ø¨Ø¢ÙŠØ©">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
            </svg>
          </button>
          <button (click)="setReadingMode('mushaf')" [class.active]="readingMode() === 'mushaf'" title="ÙˆØ¶Ø¹ Ø§Ù„Ù…ØµØ­Ù">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
            </svg>
          </button>
        </div>

        <!-- Left side: Key actions + Drawer toggle -->
        <div class="flex items-center gap-1.5 md:gap-2.5">
          <!-- Search (always visible) -->
          <button (click)="toggleSearch()" class="quran-control" [class.active]="showSearch()" title="Ø¨Ø­Ø«">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
            </svg>
          </button>

          <!-- Desktop only controls -->
          <div class="hidden md:flex items-center gap-2.5">
            <!-- Reciter -->
            <div class="inline-flex items-center gap-2 px-2.5 py-1.5 rounded-xl border border-brd/60 bg-surface-el/60">
              <span class="text-[10px] font-bold text-txt-muted">Ø§Ù„Ù‚Ø§Ø±Ø¦</span>
              <select #reciterSelect [value]="reciterId()" (change)="setReciter(reciterSelect.value)"
                class="quran-reciter-select">
                @for (r of reciters; track r.id) {
                <option [value]="r.id">{{r.name}}</option>
                }
              </select>
            </div>
            <!-- Font Size -->
            <div class="inline-flex items-center gap-1 px-2.5 py-1.5 rounded-xl border border-brd/60 bg-surface-el/60">
              <button (click)="increaseFontSize()" class="quran-size-btn" title="ØªÙƒØ¨ÙŠØ±">+</button>
              <span class="text-[11px] font-bold text-txt-muted w-7 text-center">{{fontSize()}}</span>
              <button (click)="decreaseFontSize()" class="quran-size-btn" title="ØªØµØºÙŠØ±">-</button>
              <button (click)="resetFontSize()" class="quran-size-btn" title="Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†"
                style="font-size:9px">â†º</button>
            </div>
            <!-- Bookmarks -->
            <button (click)="showBookmarksPanel.set(!showBookmarksPanel())" class="quran-control"
              [class.active]="showBookmarksPanel()" title="Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©">
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.25 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0111.186 0z" />
              </svg>
            </button>
            <!-- Audio Settings -->
            <button (click)="showAudioSettings.set(!showAudioSettings())" class="quran-control"
              [class.active]="showAudioSettings()" title="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª">
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M9 9l10.5-3m0 6.553v3.75a2.25 2.25 0 01-1.632 2.163l-1.32.377a1.803 1.803 0 11-.99-3.467l2.31-.66a2.25 2.25 0 001.632-2.163zm0 0V2.25L9 5.25v10.303m0 0v3.75a2.25 2.25 0 01-1.632 2.163l-1.32.377a1.803 1.803 0 01-.99-3.467l2.31-.66A2.25 2.25 0 009 15.553z" />
              </svg>
            </button>
            <!-- Translation -->
            <button (click)="toggleTranslation()" class="quran-control" [class.active]="showTranslation()"
              title="Ø§Ù„ØªØ±Ø¬Ù…Ø©">
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M10.5 21l5.25-11.25L21 21m-9-3h7.5M3 5.621a48.474 48.474 0 016-.371m0 0c1.12 0 2.233.038 3.334.114M9 5.25V3m3.334 2.364C11.176 10.658 7.69 15.08 3 17.502m9.334-12.138c.896.061 1.785.147 2.666.257m-4.589 8.495a18.023 18.023 0 01-3.827-5.802" />
              </svg>
            </button>
            <!-- Focus Mode -->
            <button (click)="toggleFocusMode()" class="quran-control" [class.active]="focusMode()"
              title="ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² (F)">
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" />
              </svg>
            </button>
          </div>

          <!-- Mobile: Hamburger Menu -->
          <button (click)="showSettingsDrawer.set(true)" class="md:hidden quran-control" title="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- â•â•â• MOBILE SETTINGS DRAWER â•â•â• -->
  @if (showSettingsDrawer()) {
  <div class="fixed inset-0 z-[80] md:hidden">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" (click)="showSettingsDrawer.set(false)"></div>
    <!-- Drawer -->
    <div
      class="absolute top-0 left-0 bottom-0 w-[280px] bg-surface border-l border-brd shadow-2xl overflow-y-auto animate-slide-in-right">
      <div class="p-5">
        <!-- Drawer Header -->
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-base font-black text-txt">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</h3>
          <button (click)="showSettingsDrawer.set(false)"
            class="w-8 h-8 rounded-lg bg-surface-el flex items-center justify-center text-txt-muted hover:text-txt transition-colors">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <!-- Reciter -->
        <div class="mb-5">
          <p class="text-[10px] font-bold text-txt-muted mb-2 uppercase tracking-wider">Ø§Ù„Ù‚Ø§Ø±Ø¦</p>
          <select #reciterSelectMobile [value]="reciterId()" (change)="setReciter(reciterSelectMobile.value)"
            class="w-full px-3 py-2.5 rounded-xl border border-brd bg-surface-el text-sm font-bold text-txt">
            @for (r of reciters; track r.id) {
            <option [value]="r.id">{{r.name}}</option>
            }
          </select>
        </div>

        <!-- Font Size -->
        <div class="mb-5">
          <p class="text-[10px] font-bold text-txt-muted mb-2 uppercase tracking-wider">Ø­Ø¬Ù… Ø§Ù„Ø®Ø·</p>
          <div class="flex items-center gap-2 bg-surface-el rounded-xl p-2 border border-brd">
            <button (click)="decreaseFontSize()"
              class="w-9 h-9 rounded-lg bg-surface border border-brd flex items-center justify-center text-txt font-bold hover:bg-primary/10 hover:text-primary transition-all">-</button>
            <span class="flex-1 text-center text-sm font-black text-txt">{{fontSize()}}</span>
            <button (click)="increaseFontSize()"
              class="w-9 h-9 rounded-lg bg-surface border border-brd flex items-center justify-center text-txt font-bold hover:bg-primary/10 hover:text-primary transition-all">+</button>
            <button (click)="resetFontSize()"
              class="w-9 h-9 rounded-lg bg-surface border border-brd flex items-center justify-center text-txt-muted text-xs hover:bg-primary/10 hover:text-primary transition-all">â†º</button>
          </div>
        </div>

        <!-- Divider -->
        <div class="h-px bg-brd/50 my-4"></div>

        <!-- Action Buttons -->
        <div class="space-y-2">
          <button (click)="showBookmarksPanel.set(!showBookmarksPanel()); showSettingsDrawer.set(false)"
            class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold transition-all"
            [class]="showBookmarksPanel() ? 'bg-primary/10 text-primary border border-primary/20' : 'text-txt hover:bg-surface-el border border-transparent'">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.25 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0111.186 0z" />
            </svg>
            Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©
          </button>

          <button (click)="showAudioSettings.set(!showAudioSettings()); showSettingsDrawer.set(false)"
            class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold transition-all"
            [class]="showAudioSettings() ? 'bg-primary/10 text-primary border border-primary/20' : 'text-txt hover:bg-surface-el border border-transparent'">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M9 9l10.5-3m0 6.553v3.75a2.25 2.25 0 01-1.632 2.163l-1.32.377a1.803 1.803 0 11-.99-3.467l2.31-.66a2.25 2.25 0 001.632-2.163zm0 0V2.25L9 5.25v10.303m0 0v3.75a2.25 2.25 0 01-1.632 2.163l-1.32.377a1.803 1.803 0 01-.99-3.467l2.31-.66A2.25 2.25 0 009 15.553z" />
            </svg>
            Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª
          </button>

          <button (click)="toggleTranslation(); showSettingsDrawer.set(false)"
            class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold transition-all"
            [class]="showTranslation() ? 'bg-primary/10 text-primary border border-primary/20' : 'text-txt hover:bg-surface-el border border-transparent'">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M10.5 21l5.25-11.25L21 21m-9-3h7.5M3 5.621a48.474 48.474 0 016-.371m0 0c1.12 0 2.233.038 3.334.114M9 5.25V3m3.334 2.364C11.176 10.658 7.69 15.08 3 17.502m9.334-12.138c.896.061 1.785.147 2.666.257m-4.589 8.495a18.023 18.023 0 01-3.827-5.802" />
            </svg>
            Ø§Ù„ØªØ±Ø¬Ù…Ø©
          </button>

          <button (click)="toggleFocusMode(); showSettingsDrawer.set(false)"
            class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold transition-all"
            [class]="focusMode() ? 'bg-primary/10 text-primary border border-primary/20' : 'text-txt hover:bg-surface-el border border-transparent'">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" />
            </svg>
            ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ²
          </button>
        </div>
      </div>
    </div>
  </div>
  }

  <!-- â•â•â• SEARCH PANEL â•â•â• -->
  <div class="search-panel" *ngIf="showSearch()">
    <div class="max-w-5xl mx-auto px-4">
      <div class="search-input-wrap">
        <input type="text" [ngModel]="searchQuery()" (ngModelChange)="searchQuery.set($event); performSearch()"
          placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø¢ÙŠØ§Øª Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡..." class="search-input" autofocus />
        <button (click)="toggleSearch()" class="search-close">âœ•</button>
      </div>
      <div class="search-results" *ngIf="searchResults().length > 0">
        <p class="search-count">{{ searchResults().length }} Ù†ØªÙŠØ¬Ø©</p>
        <button *ngFor="let r of searchResults()" class="search-result-item" (click)="jumpToSearchResult(r)">
          <span class="sr-surah">{{ r.verse.surahName || 'Ø³ÙˆØ±Ø© ' + r.verse.surahNumber }} : {{ r.verse.numberInSurah
            }}</span>
          <p class="sr-text">{{ r.verse.text }}</p>
          <span class="sr-context" *ngIf="r.contextBefore">...{{ r.contextBefore }}</span>
        </button>
      </div>
      <p class="search-empty" *ngIf="searchQuery().length >= 2 && searchResults().length === 0">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>
    </div>
  </div>



  <!-- â•â•â• BOOKMARKS PANEL â•â•â• -->
  <div class="bookmarks-panel" *ngIf="showBookmarksPanel()">
    <div class="max-w-5xl mx-auto px-4">
      <div class="bm-inner">
        <div class="bm-head">
          <h3>Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©</h3>
          <button (click)="showBookmarksPanel.set(false)" class="bm-close">âœ•</button>
        </div>

        <div class="bm-list" *ngIf="filteredBookmarks().length; else noBm">
          <div *ngFor="let b of filteredBookmarks()" class="bm-item">
            <div class="bm-item-info cursor-pointer hover:bg-surface-el/10 transition-colors flex-1"
              (click)="jumpToBookmark(b)">
              <div class="flex flex-col ms-2">
                <span class="text-sm font-bold text-primary">{{ b.surahName || 'Ø³ÙˆØ±Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©' }}</span>
                <span class="text-[11px] text-txt-muted font-medium">Ø§Ù„Ø¢ÙŠØ© Ø±Ù‚Ù… {{ b.ayahInSurah }}</span>
              </div>
            </div>
            <button (click)="removeBookmark(b.verseNumber, b.type)" class="bm-remove">Ø­Ø°Ù</button>
          </div>
        </div>
        <ng-template #noBm>
          <p class="bm-empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù„Ø§Ù…Ø§Øª Ù…Ø±Ø¬Ø¹ÙŠØ©</p>
        </ng-template>
      </div>
    </div>
  </div>

  <!-- â•â•â• AUDIO SETTINGS PANEL (Phase 2) â•â•â• -->
  <div class="audio-settings-panel" *ngIf="showAudioSettings()">
    <div class="max-w-5xl mx-auto px-4">
      <div class="as-inner">
        <div class="as-head">
          <h3>ğŸ§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª</h3>
          <button (click)="showAudioSettings.set(false)" class="bm-close">âœ•</button>
        </div>

        <!-- Continuous Play -->
        <div class="as-row">
          <span class="as-label">ØªØ´ØºÙŠÙ„ Ù…ØªÙˆØ§ØµÙ„</span>
          <button (click)="toggleContinuousPlay()" class="as-toggle-btn" [class.active]="continuousPlay()">
            {{ continuousPlay() ? 'â¹ Ø¥ÙŠÙ‚Ø§Ù' : 'â–¶ ØªØ´ØºÙŠÙ„' }}
          </button>
        </div>

        <!-- Speed -->
        <div class="as-row">
          <span class="as-label">Ø³Ø±Ø¹Ø© Ø§Ù„ØªÙ„Ø§ÙˆØ©</span>
          <div class="as-speed-btns">
            <button *ngFor="let s of [0.5, 0.75, 1, 1.25, 1.5, 2]" [class.active]="playbackSpeed() === s"
              (click)="setPlaybackSpeed(s)">{{ s }}x</button>
          </div>
        </div>

        <!-- Repeat -->
        <div class="as-row">
          <span class="as-label">ØªÙƒØ±Ø§Ø± ÙƒÙ„ Ø¢ÙŠØ©</span>
          <div class="as-repeat-ctrl">
            <button (click)="setRepeatCount(repeatCount() - 1)">âˆ’</button>
            <span>{{ repeatCount() }} Ù…Ø±Ø©</span>
            <button (click)="setRepeatCount(repeatCount() + 1)">+</button>
          </div>
        </div>

        <!-- Sleep Timer -->
        <div class="as-row">
          <span class="as-label">Ù…Ø¤Ù‚Øª Ø§Ù„Ù†ÙˆÙ…</span>
          <div class="as-timer-btns" *ngIf="!sleepTimerActive()">
            <button *ngFor="let m of [5, 10, 15, 30, 60]" (click)="startSleepTimer(m)">{{ m }} Ø¯</button>
          </div>
          <div class="as-timer-active" *ngIf="sleepTimerActive()">
            <span class="as-timer-countdown">â° {{ formatTimerDisplay(sleepTimerRemaining()) }}</span>
            <button (click)="clearSleepTimer()" class="as-timer-cancel">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>

        <!-- Repeat Remaining indicator -->
        <div class="as-row" *ngIf="repeatRemaining() > 0 && continuousPlay()">
          <span class="as-label">Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</span>
          <span class="as-badge">{{ repeatRemaining() }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â• MEMORIZATION PANEL (Phase 2) â•â•â• -->
  <div class="memorization-panel" *ngIf="showMemorizationPanel()">
    <div class="max-w-5xl mx-auto px-4">
      <div class="mem-inner">
        <div class="mem-head">
          <h3>ğŸ“š Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø­ÙØ¸</h3>
          <button (click)="showMemorizationPanel.set(false)" class="bm-close">âœ•</button>
        </div>

        <div class="mem-actions">
          <button (click)="toggleMemorizationMode()" class="mem-action-btn" [class.active]="memorizationMode()">
            {{ memorizationMode() ? 'ğŸ”“ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Øµ' : 'ğŸ”’ ÙˆØ¶Ø¹ Ø§Ù„Ø­ÙØ¸ (Ø¥Ø®ÙØ§Ø¡)' }}
          </button>
          <button (click)="startQuickTest()" class="mem-action-btn">
            âœï¸ Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹
          </button>
        </div>

        <!-- Playlist -->
        <div class="mem-playlist" *ngIf="memorizationPlaylist().length > 0">
          <p class="mem-playlist-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­ÙØ¸ ({{ memorizationPlaylist().length }})</p>
          <div *ngFor="let item of memorizationPlaylist()" class="mem-playlist-item">
            <span>{{ item.surahName || 'Ø¢ÙŠØ©' }} : {{ item.ayahInSurah }}</span>
            <button (click)="removeFromPlaylist(item.verseNumber)" class="bm-remove">Ø­Ø°Ù</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â• NOTE EDITOR OVERLAY (Phase 2) â•â•â• -->
  <div class="note-editor-overlay" *ngIf="activeNoteVerse() !== null">
    <div class="note-editor-card">
      <div class="note-editor-head">
        <h3>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¢ÙŠØ©</h3>
        <button (click)="closeNoteEditor()" class="bm-close">âœ•</button>
      </div>
      <div class="note-editor-body">
        <label class="note-label">Ù…Ù„Ø§Ø­Ø¸ØªÙƒ</label>
        <textarea [ngModel]="noteText()" (ngModelChange)="noteText.set($event)" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸ØªÙƒ Ø£Ùˆ ØªØ¯Ø¨Ø±Ùƒ..."
          class="note-textarea" rows="4"></textarea>
        <label class="note-label">ØªØ£Ù…Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <textarea [ngModel]="reflectionText()" (ngModelChange)="reflectionText.set($event)"
          placeholder="Ù…Ø§Ø°Ø§ ØªØ¹Ù„Ù…Øª Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¢ÙŠØ©ØŸ" class="note-textarea" rows="3"></textarea>
        <div class="note-editor-actions">
          <button (click)="saveNote()" class="note-save-btn">Ø­ÙØ¸</button>
          <button *ngIf="hasNote(activeNoteVerse()!)" (click)="deleteNote(activeNoteVerse()!)"
            class="note-delete-btn">Ø­Ø°Ù</button>
          <button (click)="closeNoteEditor()" class="note-cancel-btn">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â• QUICK TEST OVERLAY (Phase 2) â•â•â• -->
  <div class="quick-test-overlay" *ngIf="quickTestMode()">
    <div class="quick-test-card">
      <div class="quick-test-head">
        <h3>âœï¸ Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹</h3>
        <button (click)="exitQuickTest()" class="bm-close">âœ•</button>
      </div>
      @if (quickTestVerse(); as v) {
      <div class="quick-test-body">
        <p class="quick-test-hint">
          {{ v.surahName || 'Ø³ÙˆØ±Ø© ' + v.surahNumber }} â€” Ø§Ù„Ø¢ÙŠØ© {{ v.numberInSurah }}
        </p>
        <p class="quick-test-prompt">Ù‡Ù„ ØªØ³ØªØ·ÙŠØ¹ ØªÙ„Ø§ÙˆØ© Ù‡Ø°Ù‡ Ø§Ù„Ø¢ÙŠØ© Ù…Ù† Ø°Ø§ÙƒØ±ØªÙƒØŸ</p>

        @if (!quickTestRevealed()) {
        <div class="quick-test-hidden">
          <span>????</span>
          <button (click)="revealQuickTest()" class="quick-test-reveal-btn">ÙƒØ´Ù Ø§Ù„Ø¢ÙŠØ©</button>
        </div>
        } @else {
        <p class="quick-test-verse" [style.font-size.px]="fontSize()">{{ v.text }}</p>
        @if (v.translationEn && showTranslation()) {
        <p class="quick-test-translation">{{ v.translationEn }}</p>
        }
        }

        <div class="quick-test-nav">
          <button (click)="nextQuickTest()" class="quick-test-next-btn">Ø³Ø¤Ø§Ù„ Ø¢Ø®Ø±</button>
          <button (click)="exitQuickTest()" class="quick-test-exit-btn">Ø¥Ù†Ù‡Ø§Ø¡</button>
        </div>
      </div>
      }
    </div>
  </div>

  <!-- â•â•â• VERSE OF THE DAY (Floating Notification) â•â•â• -->
  @if (verseOfTheDay(); as votd) {
  @if (!showVotdPopup() && !loading() && !focusMode()) {
  <div class="votd-toast">
    <div class="votd-toast-inner">
      <div class="votd-toast-header">
        <div class="votd-toast-badge">
          <span>ğŸŒŸ</span>
          <span class="votd-toast-title">Ø¢ÙŠØ© Ø§Ù„ÙŠÙˆÙ…</span>
        </div>
        <button (click)="showVotdPopup.set(true)" class="votd-toast-close" title="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
      </div>
      <p class="votd-toast-text font-quran">{{ votd.text }}</p>
      <p class="votd-toast-ref">{{ votd.surahName || 'Ø³ÙˆØ±Ø© ' + votd.surahNumber }} â€” Ø§Ù„Ø¢ÙŠØ© {{ votd.numberInSurah }}</p>
    </div>
  </div>
  }
  }

  <!-- â•â•â• WHERE AM I BAR â•â•â• -->
  @if (verses().length && !loading() && !focusMode()) {
  <div class="where-bar chrome-el">
    <div
      class="max-w-5xl mx-auto px-4 flex items-center justify-between gap-2 text-[11px] font-bold text-txt-muted w-full">
      <span>Ø§Ù„Ø¬Ø²Ø¡ {{ juzNumber() }}</span>
      @if (surahsInJuz(); as surahs) {
      @if (surahs.length) {
      <span>{{ surahs.length > 1 ? surahs.length + ' Ø³ÙˆØ±' : surahs[0].name }}</span>
      }
      }
      <span>{{ verses().length }} Ø¢ÙŠØ©</span>
      @if (mushafPages().length) {
      <span>{{ mushafPages().length > 1 ? 'ØµÙØ­Ø§Øª ' + mushafPages()[0] + ' - ' + mushafPages()[mushafPages().length - 1]
        : 'ØµÙØ­Ø© ' + mushafPages()[0] }}</span>
      }
    </div>
  </div>
  }

  <main class="max-w-5xl mx-auto px-4 md:px-6 py-6 md:py-8">
    @if (loading()) {
    <div class="space-y-6">
      @for(i of [1,2,3]; track i) {
      <div class="quran-skeleton rounded-3xl p-6 md:p-8">
        <div class="h-5 rounded-full bg-surface-el/70 w-36 mb-4"></div>
        <div class="space-y-3">
          <div class="h-4 rounded-full bg-surface-el/60 w-full"></div>
          <div class="h-4 rounded-full bg-surface-el/60 w-5/6"></div>
          <div class="h-4 rounded-full bg-surface-el/60 w-4/6"></div>
        </div>
      </div>
      }
    </div>
    } @else {
    @if (accessError(); as accessMessage) {
    <section class="quran-state warn">
      <h2>Ù„Ø§ ÙŠÙ…ÙƒÙ† ÙØªØ­ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¢Ù†</h2>
      <p>{{accessMessage}}</p>
      <a routerLink="/khatmat" class="quran-state-btn">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø®ØªÙ…Ø§Øª</a>
    </section>
    } @else if (loadError()) {
    <section class="quran-state err">
      <h2>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¢ÙŠØ§Øª</h2>
      <p>{{loadError()}}</p>
      <button (click)="loadJuz(juzNumber())" class="quran-state-btn">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
    </section>
    } @else if (!verses().length) {
    <section class="quran-state">
      <h2>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¢ÙŠØ§Øª</h2>
      <p>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡</p>
    </section>
    } @else {

    <!-- HERO (hideable in focus) -->


    <!-- â•â•â• MODE: CONTINUOUS â•â•â• -->
    @if (readingMode() === 'continuous') {
    <section class="quran-continuous-section rounded-[2rem] border border-brd/50 p-6 md:p-10 bg-surface">
      <div class="quran-continuous-text font-quran leading-[2.8] md:leading-[3.2]" [style.fontSize.px]="fontSize()"
        [class.mem-blurred]="memorizationMode()">
        @for (verse of verses(); track verse.number) {
        <!-- Surah header if first ayah -->
        @if (verse.numberInSurah === 1) {
        <div class="surah-header-inline" [id]="'verse-' + verse.number">
          <span class="surah-header-name">{{ verse.surahName }}</span>
        </div>
        }
        @for (word of getVerseWords(verse); track $index) {
        <button type="button" class="quran-word"
          [class.quran-word-playing]="currentPlayingVerse() === verse.number && currentPlayingWordIndex() === $index"
          [class.quran-word-active-verse]="currentPlayingVerse() === verse.number && currentPlayingWordIndex() !== $index"
          (click)="pronounceWord(word, verse, $index)" [style.fontSize.px]="fontSize()">{{word}}</button>
        }
        <span class="quran-ayah-badge" [style.fontSize.px]="fontSize() * 0.45">{{verse.numberInSurah}}</span>

        <!-- Verse actions (bookmark) -->
        <span class="verse-actions-inline">
          <button class="va-btn" (click)="playAudio(verse)" title="ØªØ´ØºÙŠÙ„">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
          </button>
          <button class="va-btn" (click)="copyVerse(verse)" title="Ù†Ø³Ø®">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
          </button>
          <button class="va-btn" [class.bookmarked]="isBookmarked(verse.number)" (click)="addBookmark(verse, 'khatma')"
            title="Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø©">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
            </svg>
          </button>

        </span>

        @if (memorizationMode()) {
        <button class="mem-reveal-btn" (click)="toggleRevealVerse(verse.number)">
          {{ isVerseRevealed(verse.number) ? 'Ø¥Ø®ÙØ§Ø¡' : 'ÙƒØ´Ù' }}
        </button>
        }

        @if (showTranslation()) {
        <span class="quran-inline-translation block w-full">
          {{verse.translationEn || 'Translation not available.'}}
        </span>
        }
        }
      </div>
    </section>
    }

    <!-- â•â•â• MODE: VERSE BY VERSE â•â•â• -->
    @if (readingMode() === 'verse' && currentVerse(); as v) {
    <section class="verse-mode-section">
      <div class="verse-card">
        <!-- Surah info -->
        <div class="verse-surah-label">{{ v.surahName }} â€” Ø¢ÙŠØ© {{ v.numberInSurah }}</div>

        <div class="verse-mode-text font-quran" [style.fontSize.px]="fontSize()">
          @for (word of getVerseWords(v); track $index) {
          <button type="button" class="quran-word"
            [class.quran-word-playing]="currentPlayingVerse() === v.number && currentPlayingWordIndex() === $index"
            [class.quran-word-active-verse]="currentPlayingVerse() === v.number && currentPlayingWordIndex() !== $index"
            (click)="pronounceWord(word, v, $index)" [style.fontSize.px]="fontSize()">{{word}}</button>
          }
        </div>

        @if (showTranslation() && v.translationEn) {
        <p class="verse-mode-translation">{{ v.translationEn }}</p>
        }

        <!-- Verse actions -->
        <div class="verse-mode-actions">
          <button (click)="playAudio(v)" class="vma-btn">ğŸ”Š ØªØ´ØºÙŠÙ„</button>
          <button (click)="copyVerse(v)" class="vma-btn">ğŸ“‹ Ù†Ø³Ø®</button>
          <button (click)="addBookmark(v, 'hifz')" class="vma-btn">ï¿½ Ø­ÙØ¸</button>
          <button (click)="shareVerse(v, 'whatsapp')" class="vma-btn">ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ©</button>
        </div>
      </div>

      <!-- Navigation -->
      <div class="verse-nav">
        <button (click)="prevVerse()" [disabled]="currentVerseIndex() === 0" class="verse-nav-btn">
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
          </svg>
          Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        </button>
        <span class="verse-nav-counter">{{ currentVerseIndex() + 1 }} / {{ verses().length }}</span>
        <button (click)="nextVerse()" [disabled]="currentVerseIndex() === verses().length - 1" class="verse-nav-btn">
          Ø§Ù„ØªØ§Ù„ÙŠØ©
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
          </svg>
        </button>
      </div>
    </section>
    }

    <!-- â•â•â• MODE: MUSHAF (text simulation) â•â•â• -->
    @if (readingMode() === 'mushaf') {
    <section class="mushaf-section">
      <div class="mushaf-page-card">
        <div class="mushaf-page-header">
          <span class="mushaf-page-num">ØµÙØ­Ø© {{ mushafCurrentPage() }}</span>
          <span class="mushaf-juz-label">Ø§Ù„Ø¬Ø²Ø¡ {{ juzNumber() }}</span>
        </div>

        <div class="mushaf-text font-quran" [style.fontSize.px]="fontSize()">
          @for (verse of mushafPageVerses(); track verse.number) {
          @if (verse.numberInSurah === 1) {
          <div class="surah-header-mushaf">
            <span>{{ verse.surahName }}</span>
          </div>
          }
          @for (word of getVerseWords(verse); track $index) {
          <button type="button" class="quran-word"
            [class.quran-word-playing]="currentPlayingVerse() === verse.number && currentPlayingWordIndex() === $index"
            (click)="pronounceWord(word, verse, $index)" [style.fontSize.px]="fontSize()">{{word}}</button>
          }
          <span class="quran-ayah-badge" [style.fontSize.px]="fontSize() * 0.45">{{verse.numberInSurah}}</span>
          }
        </div>

        <div class="mushaf-footer">
          @if (showTranslation()) {
          @for (verse of mushafPageVerses(); track verse.number) {
          <p class="mushaf-translation">{{ verse.numberInSurah }}. {{ verse.translationEn || '' }}</p>
          }
          }
        </div>
      </div>

      <!-- Mushaf Pagination -->
      <div class="mushaf-nav">
        <button (click)="prevMushafPage()" [disabled]="mushafCurrentPage() === mushafPages()[0]" class="verse-nav-btn">
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
          </svg>
          Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        </button>
        <span class="verse-nav-counter">{{ mushafPages().indexOf(mushafCurrentPage()) + 1 }} / {{ mushafPages().length
          }}</span>
        <button (click)="nextMushafPage()" [disabled]="mushafCurrentPage() === mushafPages()[mushafPages().length - 1]"
          class="verse-nav-btn">
          Ø§Ù„ØªØ§Ù„ÙŠØ©
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
          </svg>
        </button>
      </div>
    </section>
    }

    <!-- Playing Bar -->
    @if (currentPlayingVerse(); as playingNum) {
    <div class="quran-playing-bar">
      <div class="flex items-center gap-3">
        <div class="quran-playing-indicator"></div>
        <span class="text-xs font-bold text-txt">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ´ØºÙŠÙ„...</span>
      </div>
      <button (click)="stopPlayback()" class="quran-playing-stop">
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z" />
        </svg>
        Ø¥ÙŠÙ‚Ø§Ù
      </button>
    </div>
    }
    }
    }

    @if (verses().length && !loadError() && !accessError()) {
    <div class="mt-10 md:mt-12 text-center">
      <button (click)="markAsCompleted()" class="quran-complete-btn">
        <span>ØµØ¯Ù‚ Ø§Ù„Ù„Ù‡ Ø§Ù„Ø¹Ø¸ÙŠÙ…</span>
        <small>Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¬Ø²Ø¡</small>
      </button>
    </div>
    }
  </main>

  <!-- AI Coach FAB -->
  <div class="fixed bottom-6 left-6 z-40 chrome-el">
    <button (click)="showAiCoach.set(!showAiCoach())" class="quran-ai-fab">
      <span class="text-xs font-bold text-txt">Ø§Ù„Ù…ØµØ­Ø­ Ø§Ù„Ø°ÙƒÙŠ</span>
      <div class="quran-ai-fab-icon">
        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z" />
        </svg>
      </div>
    </button>
  </div>

  @if (showAiCoach()) {
  <div class="fixed bottom-20 left-6 z-40 w-[22rem] max-w-[calc(100vw-2rem)] h-[390px] quran-ai-panel">
    <div class="quran-ai-panel-head">
      <h3 class="font-bold text-txt">Ø§Ù„Ù…ØµØ­Ø­ Ø§Ù„Ø°ÙƒÙŠ</h3>
      <button (click)="showAiCoach.set(false)" class="text-txt-muted hover:text-txt">
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="flex-1 p-4 overflow-y-auto">
      @if (!aiRecording()) {
      <div class="text-center py-10">
        <button (click)="startAiRecording()" class="quran-record-btn">
          <svg class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z" />
          </svg>
        </button>
        <p class="text-sm font-bold text-txt mt-3">Ø§Ø¶ØºØ· Ù„Ù„ØªØ³Ø¬ÙŠÙ„</p>
        <p class="text-xs text-txt-muted mt-1">ØµØ­Ø­ ØªÙ„Ø§ÙˆØªÙƒ Ù„Ù„Ø¢ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</p>
      </div>
      } @else {
      <div class="text-center py-10">
        <div class="quran-recording-indicator mx-auto mb-4"></div>
        <p class="text-sm font-bold text-err">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„...</p>
        <button (click)="stopAiRecording()"
          class="mt-4 text-xs bg-surface-el px-3 py-1.5 rounded-lg border hover:bg-err hover:text-white transition-colors">Ø¥ÙŠÙ‚Ø§Ù</button>
      </div>
      }
    </div>
  </div>
  }

  @if (showToast()) {
  <div
    class="fixed bottom-24 left-1/2 -translate-x-1/2 z-[70] px-4 py-2 rounded-xl bg-primary text-white text-xs font-bold shadow-lg">
    {{toastMessage()}}
  </div>
  }
</div>